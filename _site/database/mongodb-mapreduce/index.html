<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.9.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>            Understand Idempotence of Reduce Function in MongoDB      get value from data      </title>




<meta name="description" content="Here are the characteristics of Reduce Function Idempotence:">




<meta name="author" content="Bin">

<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="get value from data">
<meta property="og:title" content="Understand Idempotence of Reduce Function in MongoDB">


  <link rel="canonical" href="http://localhost:4000/database/mongodb-mapreduce/">
  <meta property="og:url" content="http://localhost:4000/database/mongodb-mapreduce/">



  <meta property="og:description" content="Here are the characteristics of Reduce Function Idempotence:">

















  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2018-02-03T22:32:00-08:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Bin Shi",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>







<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="get value from data Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">get value from data</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/about/" >about</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/portfolio/" >portfolio</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="http://localhost:4000/assets/images/bio.png" alt="Bin" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Bin</h3>
    
    
      <p class="author__bio" itemprop="description">
        Data Engineer
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">San Mateo, CA</span>
        </li>
      

      

      

      

      
        <li>
          <a href="https://twitter.com/_binshi" itemprop="sameAs">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/binshi" itemprop="sameAs">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/ishibin" itemprop="sameAs">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Understand Idempotence of Reduce Function in MongoDB">
    <meta itemprop="description" content="Here are the characteristics of Reduce Function Idempotence:">
    <meta itemprop="datePublished" content="February 03, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Understand Idempotence of Reduce Function in MongoDB
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#problem-calculate-average-price-using-mapreduce">Problem: Calculate Average Price Using MapReduce</a>
    <ul>
      <li><a href="#description">Description</a></li>
      <li><a href="#dataset">Dataset</a></li>
    </ul>
  </li>
  <li><a href="#sub-problem-calculate-the-average-price-for-each-stock">Sub-Problem: Calculate the Average Price for Each Stock</a>
    <ul>
      <li><a href="#approach-i--mapreduce-using-foreach">Approach I:  MapReduce using forEach()</a></li>
      <li><a href="#approach-ii-mapreduce-using-arraysum">Approach II: MapReduce using Array.sum()</a></li>
      <li><a href="#validation-using-nosql-aggregate">Validation using NoSQL Aggregate</a></li>
      <li><a href="#explanation-and-fix">Explanation and Fix</a></li>
      <li><a href="#but-why">But WHY?</a></li>
    </ul>
  </li>
  <li><a href="#sub-problem-calculate-the-average-price-for-all-stocks">Sub-Problem: Calculate the Average Price for All Stocks</a>
    <ul>
      <li><a href="#approach">Approach</a></li>
      <li><a href="#but-why-1">But WHY?</a></li>
    </ul>
  </li>
  <li><a href="#summary">Summary</a></li>
</ul>
            </nav>
          </aside>
        
        <p>Here are the characteristics of <strong><a href="https://docs.mongodb.com/manual/tutorial/troubleshoot-reduce-function/#ensure-reduce-function-idempotence">Reduce Function Idempotence</a></strong>:</p>

<ul>
  <li>a map-reduce operation may call a <code class="highlighter-rouge">reduce</code> multiple times for the same key</li>
  <li>it won’t call a <code class="highlighter-rouge">reduce</code> for single instances of a key in the working set</li>
  <li>the <code class="highlighter-rouge">reduce</code> function must return a value of the same type as the value emitted from the <code class="highlighter-rouge">map</code> function.</li>
</ul>

<h2 id="problem-calculate-average-price-using-mapreduce">Problem: Calculate Average Price Using MapReduce</h2>

<h3 id="description">Description</h3>

<p>Find the <strong>average</strong> price of <code class="highlighter-rouge">stock_price_high</code> values for each stock and the total average price for all the stock using map-reduce in MongoDB.</p>

<h3 id="dataset">Dataset</h3>

<p>The dataset comes from http://msis.neu.edu/nyse, and it has more than 9 million stock price records. After importing them to MongoDB database using <code class="highlighter-rouge">mongdoimport</code> command, the data format is like below.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&gt;</span><span class="w"> </span><span class="err">use</span><span class="w"> </span><span class="err">nysedb;</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="err">db.stocks.count()</span><span class="w">
</span><span class="mi">9211031</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="err">db.stocks.findOne();</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="s2">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"5a7158a80cf8a8197ba29570"</span><span class="err">)</span><span class="p">,</span><span class="w">
    </span><span class="s2">"exchange"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"NYSE"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"stock_symbol"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AEA"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"date"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"2010-02-08"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"stock_price_open"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">4.42</span><span class="p">,</span><span class="w">
    </span><span class="s2">"stock_price_high"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">4.42</span><span class="p">,</span><span class="w">
    </span><span class="s2">"stock_price_low"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">4.21</span><span class="p">,</span><span class="w">
    </span><span class="s2">"stock_price_close"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">4.24</span><span class="p">,</span><span class="w">
    </span><span class="s2">"stock_volume"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">205500</span><span class="p">,</span><span class="w">
    </span><span class="s2">"stock_price_adj_close"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">4.24</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Note: The collection name is ‘stocks’. And here is the bash script to import this dataset.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span>/bin/bash
<span class="nv">FILES</span><span class="o">=</span>NYSE/NYSE_daily_prices_<span class="k">*</span>.csv
<span class="k">for </span>f <span class="k">in</span> <span class="nv">$FILES</span>
<span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"Processing </span><span class="nv">$f</span><span class="s2"> file..."</span>
    <span class="c"># ls -l $f</span>
    mongoimport <span class="nt">--db</span> nysedb <span class="nt">--collection</span> stocks <span class="nt">--type</span> csv <span class="nt">--headerline</span> <span class="nt">--file</span> <span class="nv">$f</span>
<span class="k">done</span>
</code></pre></div></div>

<h2 id="sub-problem-calculate-the-average-price-for-each-stock">Sub-Problem: Calculate the Average Price for Each Stock</h2>

<p>Let’s take the <code class="highlighter-rouge">stock_price_high</code>property as an example to calculate the average.</p>

<h3 id="approach-i--mapreduce-using-foreach">Approach I:  MapReduce using <code class="highlighter-rouge">forEach()</code></h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stock_symbol</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stock_price_high</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">;</span>
    <span class="nx">num</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">});</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">sum</span> <span class="o">/</span> <span class="nx">num</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">stocks</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">reduce</span><span class="p">,</span> <span class="p">{</span><span class="na">out</span><span class="p">:</span><span class="s2">"mr_stock_price_avg_each"</span><span class="p">})</span>
</code></pre></div></div>

<p>This job runs successfully with 9211031 inputs and 2853 outputs. And here is the result of “AA”.</p>

<blockquote>
  <p>{ “_id” : “AA”, “value” : 64.26173484209001 }</p>
</blockquote>

<p>The function looks quite straightforward. Now let’s use another short version and cross-validated.</p>

<h3 id="approach-ii-mapreduce-using-arraysum">Approach II: MapReduce using <code class="highlighter-rouge">Array.sum()</code></h3>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">let</span><span class="w"> </span><span class="err">map</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">emit(this.stock_symbol</span><span class="p">,</span><span class="w"> </span><span class="err">this.stock_price_high);</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">let</span><span class="w"> </span><span class="err">reduce</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">(key</span><span class="p">,</span><span class="w"> </span><span class="err">values)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">sum</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">Array.sum(values);</span><span class="w">
  </span><span class="err">num</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">values.length;</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">db.stocks.mapReduce(map</span><span class="p">,</span><span class="w"> </span><span class="err">reduce</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="err">out</span><span class="p">:</span><span class="s2">"mr_stock_price_avg_each"</span><span class="p">}</span><span class="err">)</span><span class="w">
</span></code></pre></div></div>

<p>Again, here is the result of “AA”.</p>

<blockquote>
  <p>{ “_id” : “AA”, “value” : 64.26173484209001 }</p>
</blockquote>

<h3 id="validation-using-nosql-aggregate">Validation using NoSQL Aggregate</h3>

<p>The value seems matching the previous approach. How could it be wrong? However, you will be surprised when you run this NoSQL aggregate to calculate the same average value for stock “AA”.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&gt;</span><span class="w"> </span><span class="err">db.stocks.aggregate(</span><span class="w">
   </span><span class="p">[</span><span class="w">
     </span><span class="p">{</span><span class="w">
       </span><span class="err">$match</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">stock_symbol</span><span class="p">:</span><span class="w"> </span><span class="s2">"AA"</span><span class="p">}</span><span class="w">
     </span><span class="p">},</span><span class="w">
     </span><span class="p">{</span><span class="w">
       </span><span class="err">$group</span><span class="p">:</span><span class="w">
         </span><span class="p">{</span><span class="w">
           </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="s2">"$stock_symbol"</span><span class="p">,</span><span class="w">
           </span><span class="err">avgAmount</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">$avg</span><span class="p">:</span><span class="w"> </span><span class="s2">"$stock_price_high"</span><span class="w"> </span><span class="p">}</span><span class="w">
         </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="err">)</span><span class="w">
</span></code></pre></div></div>

<p>However, the output is <code class="highlighter-rouge">52.45968205467008</code>, which is different. Now, which one is right?</p>

<p>Since the stock “AA”’s records are all in file NYSE_daily_prices_A.csv, use Excel can easily calculate the average, which is also <code class="highlighter-rouge">52.45968205</code>. So it must be the right value. (Consider they are 52.45968205 since precision after the 7th of . does not matter much in this case.)</p>

<h3 id="explanation-and-fix">Explanation and Fix</h3>

<p>Here is the code to fix the bug.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stock_symbol</span><span class="p">,</span> <span class="p">{</span><span class="s2">"price"</span><span class="p">:</span><span class="k">this</span><span class="p">.</span><span class="nx">stock_price_high</span><span class="p">,</span> <span class="s2">"count"</span><span class="p">:</span><span class="mi">1</span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">reducedVal</span> <span class="o">=</span> <span class="p">{</span><span class="na">price</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">count</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
  
  <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
    <span class="nx">reducedVal</span><span class="p">.</span><span class="nx">price</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">price</span><span class="p">;</span>
    <span class="nx">reducedVal</span><span class="p">.</span><span class="nx">count</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="nx">reducedVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">average</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">reducedValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">reducedValue</span><span class="p">.</span><span class="nx">price</span> <span class="o">/</span> <span class="nx">reducedValue</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">stocks</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">reduce</span><span class="p">,</span> <span class="p">{</span><span class="na">out</span><span class="p">:</span><span class="s2">"mr_stock_price_avg_each_fix"</span><span class="p">,</span> <span class="na">finalize</span><span class="p">:</span><span class="nx">average</span><span class="p">})</span>
</code></pre></div></div>

<h3 id="but-why">But WHY?</h3>

<p>Go back and check <a href="https://docs.mongodb.com/manual/reference/command/mapReduce/#requirements-for-the-reduce-function">Requirements for the <code class="highlighter-rouge">reduce</code> Function</a>, notice this requirement:</p>

<blockquote>
  <p>Because it is possible to invoke the <code class="highlighter-rouge">reduce</code> function more than once for the same key, the following properties need to be true:</p>

  <ul>
    <li>
      <p>the <em>type</em> of the return object must be <strong>identical</strong> to the type of the <code class="highlighter-rouge">value</code> emitted by the <code class="highlighter-rouge">map</code>function.</p>
    </li>
    <li>
      <p>the <code class="highlighter-rouge">reduce</code> function must be <em>associative</em>. The following statement must be true:</p>
    </li>
  </ul>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reduce(key, [ C, reduce(key, [ A, B ]) ] ) == reduce( key, [ C, A, B ] )
</code></pre></div></div>

<p>However, <a href="http://www.dcs.ed.ac.uk/home/mhe/plume/node35.html">average operation is not associative</a>. so it could not be in the reduce method.</p>

<p>For example, considering stock “AA” with prices [1, 2, 6], the correct average should be 3. However, if the reduce job somehow is called twice, the first of which has input [1, 2], then the average is 1.5. Then the second call of [1.5, 6] gets 3.75 as the average, which is wrong. (Number 1.5 is the result of first reduce output.) It looks like below if you put it in the formula.</p>

<blockquote>
  <p>average(“AA”, [6, average (“AA”, [1, 2])]) ≠ average (“AA”, [6, 1, 2])</p>
</blockquote>

<p>So, it has to use a finalize method, which manipulates the result of the reduce job after it finishes.</p>

<h2 id="sub-problem-calculate-the-average-price-for-all-stocks">Sub-Problem: Calculate the Average Price for All Stocks</h2>

<h3 id="approach">Approach</h3>

<p>Reuse and modified the solution of the previous sub-problem. Here is the algorithm.</p>

<ol>
  <li>Have global variable sumAll to store the running sum for every occurrence of a stock</li>
  <li>Counter the number of prices, and store in the countAll</li>
  <li>Return a list [avgEach, avgAll] in the finalizer</li>
</ol>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stock_symbol</span><span class="p">,</span> <span class="p">{</span><span class="s2">"price"</span><span class="p">:</span><span class="k">this</span><span class="p">.</span><span class="nx">stock_price_high</span><span class="p">,</span> <span class="s2">"count"</span><span class="p">:</span><span class="mi">1</span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">reducedVal</span> <span class="o">=</span> <span class="p">{</span><span class="na">price</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">count</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
  
  <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span>
    <span class="nx">reducedVal</span><span class="p">.</span><span class="nx">price</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">price</span><span class="p">;</span>
    <span class="nx">reducedVal</span><span class="p">.</span><span class="nx">count</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
    
    <span class="nx">sumAll</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">price</span><span class="p">;</span>
    <span class="nx">countAll</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>
  <span class="p">});</span>
  
  <span class="k">return</span> <span class="nx">reducedVal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">avgAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">reducedValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span> <span class="na">avg</span><span class="p">:</span> <span class="nx">reducedValue</span><span class="p">.</span><span class="nx">price</span> <span class="o">/</span> <span class="nx">reducedValue</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="na">allAvg</span><span class="p">:</span> <span class="nx">sumAll</span><span class="o">/</span><span class="nx">countAll</span> <span class="p">}</span>
<span class="p">}</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">stocks</span><span class="p">.</span><span class="nx">mapReduce</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">reduce</span><span class="p">,</span> <span class="p">{</span><span class="na">out</span><span class="p">:</span><span class="s2">"mr_stock_price_avg_all"</span><span class="p">,</span> <span class="na">scope</span><span class="p">:{</span><span class="na">sumAll</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="na">countAll</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span><span class="na">finalize</span><span class="p">:</span><span class="nx">avgAll</span><span class="p">})</span>
</code></pre></div></div>
<p>Let’s check the output value of “AA”:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="s2">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"value"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"avg"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">52.459682054670246</span><span class="p">,</span><span class="w"> </span><span class="s2">"allAvg"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">32.96151152346334</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then validate this result using aggregation in mongo shell.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&gt;</span><span class="w"> </span><span class="err">db.stocks.aggregate(</span><span class="w">
   </span><span class="p">[</span><span class="w">
     </span><span class="p">{</span><span class="w">
       </span><span class="err">$group</span><span class="p">:{</span><span class="w">
         </span><span class="err">_id</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
         </span><span class="err">averageHighPrice</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">$avg</span><span class="p">:</span><span class="w"> </span><span class="s2">"$stock_price_high"</span><span class="w"> </span><span class="p">}</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="err">)</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="s2">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s2">"averageHighPrice"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">29.0213587773182</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>What? Mismatch again!</p>

<h3 id="but-why-1">But WHY?</h3>

<p><strong>Because the MongoDB engine <a href="https://docs.mongodb.com/manual/reference/command/mapReduce/#requirements-for-the-reduce-function">won’t call a <code class="highlighter-rouge">reduce</code> for single instances of a key</a> in the working set.</strong></p>

<p>To fix this problem, simply calculate the running sum and counts in the <code class="highlighter-rouge">map</code> function, because every record will be mapped no matter what.</p>

<p>So here is the corrected solution.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">let</span><span class="w"> </span><span class="err">map</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">sumAll</span><span class="w"> </span><span class="err">+=</span><span class="w"> </span><span class="err">this.stock_price_high;</span><span class="w">
    </span><span class="err">countAll</span><span class="w"> </span><span class="err">+=</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="err">emit(this.stock_symbol</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">"price"</span><span class="p">:</span><span class="err">this.stock_price_high</span><span class="p">,</span><span class="w"> </span><span class="s2">"count"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="err">);</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">let</span><span class="w"> </span><span class="err">reduce</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">(key</span><span class="p">,</span><span class="w"> </span><span class="err">values)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">reducedVal</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span><span class="err">price</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="err">count</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="w">
  
  </span><span class="err">values.forEach(function(v)</span><span class="p">{</span><span class="w">
    </span><span class="err">reducedVal.price</span><span class="w"> </span><span class="err">+=</span><span class="w"> </span><span class="err">v.price;</span><span class="w">
    </span><span class="err">reducedVal.count</span><span class="w"> </span><span class="err">+=</span><span class="w"> </span><span class="err">v.count;</span><span class="w">
  </span><span class="p">}</span><span class="err">);</span><span class="w">
  
  </span><span class="err">return</span><span class="w"> </span><span class="err">reducedVal;</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">let</span><span class="w"> </span><span class="err">avgAll</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">function</span><span class="w"> </span><span class="err">(key</span><span class="p">,</span><span class="w"> </span><span class="err">reducedValue)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="err">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">avg</span><span class="p">:</span><span class="w"> </span><span class="err">reducedValue.price</span><span class="w"> </span><span class="err">/</span><span class="w"> </span><span class="err">reducedValue.count</span><span class="p">,</span><span class="w"> </span><span class="err">allAvg</span><span class="p">:</span><span class="w"> </span><span class="err">sumAll/countAll</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">db.stocks.mapReduce(map</span><span class="p">,</span><span class="w"> </span><span class="err">reduce</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="err">out</span><span class="p">:</span><span class="s2">"mr_stock_price_avg_all"</span><span class="p">,</span><span class="w"> </span><span class="err">scope</span><span class="p">:{</span><span class="err">sumAll</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="err">countAll</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span><span class="err">finalize</span><span class="p">:</span><span class="err">avgAll</span><span class="p">}</span><span class="err">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="summary">Summary</h2>

<p>When using the map-reduce, it is essential to follow <a href="https://docs.mongodb.com/manual/reference/command/mapReduce/#requirements-for-the-reduce-function">the requirement</a> of <code class="highlighter-rouge">reduce function</code> as below. Any violation may lead to incorrect result.</p>

<ul>
  <li>MongoDB will <strong>not</strong> call the <code class="highlighter-rouge">reduce</code> function for a key that has only a single value. The <code class="highlighter-rouge">values</code>argument is an array whose elements are the <code class="highlighter-rouge">value</code> objects that are “mapped” to the <code class="highlighter-rouge">key</code>.</li>
  <li>MongoDB can invoke the <code class="highlighter-rouge">reduce</code> function more than once for the same key. In this case, the previous output from the <code class="highlighter-rouge">reduce</code> function for that key will become one of the input values to the next <code class="highlighter-rouge">reduce</code> function invocation for that key.</li>
  <li>The <code class="highlighter-rouge">reduce</code> function can access the variables defined in the <code class="highlighter-rouge">scope</code> parameter.</li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/#mongodb" class="page__taxonomy-item" rel="tag">mongodb</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/categories/#database" class="page__taxonomy-item" rel="tag">database</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-02-03T22:32:00-08:00">February 03, 2018</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Understand+Idempotence+of+Reduce+Function+in+MongoDB%20http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmongodb-mapreduce%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmongodb-mapreduce%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmongodb-mapreduce%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmongodb-mapreduce%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/learn/spark-scala/" class="pagination--pager" title="Got new skills: Spark &amp; Scala
">Previous</a>
    
    
      <a href="http://localhost:4000/big-data/hadoop-hdfs-connection/" class="pagination--pager" title="Troubleshoot HDFS Connection Exception
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/education/M.S-NEU/" rel="permalink">Completed the M.S Degree in Information Systems
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">December 2018, I finished my master degree in Information Systems in NEU, with a GPA of 3.96.

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/algorithm/key-value-store/" rel="permalink">Versioned Key-Value Store
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Versioned Key-Value Store

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/big-data/top-k-rated-movies/" rel="permalink">Use MapReduce to Find the Top k Rated Movies
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Use MapReduce to find the top k rated movies in the movieLens dataset

</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "http://localhost:4000/assets/images/default-teaser.png"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/learn/bittiger-bigdata-certificate/" rel="permalink">Big Data Certificate @Bittiger!
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">

</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
  <input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  <div id="results" class="results"></div>
</div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="https://github.com/ishibin"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Bin Shi. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://localhost:4000/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.0.2/js/all.js"></script>



  
  
  <script defer src="http://localhost:4000/assets/js/lunr/lunr.min.js"></script>
  <script defer src="http://localhost:4000/assets/js/lunr/lunr-store.js"></script>
  <script defer src="http://localhost:4000/assets/js/lunr/lunr-en.js"></script>





    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/database/mongodb-mapreduce/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/database/mongodb-mapreduce"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://ishibin.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>